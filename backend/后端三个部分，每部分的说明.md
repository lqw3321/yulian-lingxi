# 后端说明文档

本文档说明语联灵犀后端系统的功能架构，分为三个主要部分：大模型接入、工具接入、前后端连接。

---

## 一、大模型接入

### 1.1 功能概述

大模型接入层负责与各种大模型服务进行交互，支持：
- **OpenAI 兼容 API**（如阿里云百炼平台 DashScope、OpenAI 等）
- **本地模型**（通过 HTTP API 调用）
- **降级方案**（当大模型不可用时，使用基于规则的意图识别）

### 1.2 核心文件

#### `app/core/llm_service.py` - 大模型服务抽象层

**功能：** 提供统一的接口调用不同的大模型服务，自动处理 API 调用失败时的降级。

**主要功能：**
- 调用大模型进行对话
- 支持 OpenAI 兼容 API 和本地模型
- 自动降级到规则识别（当 API 不可用时）

#### `app/core/prompt.py` - 提示词模板管理

**功能：** 管理所有与大模型交互的提示词模板，包括意图识别提示词。

**主要功能：**
- 定义意图识别提示词模板
- 支持多工具链式调用识别
- 包含所有可用工具的说明

#### `app/core/agent.py` - 智能 Agent

**功能：** 协调大模型和工具调度，是整个系统的核心调度器。

**主要功能：**
- 接收用户自然语言输入
- 调用大模型进行意图识别
- 解析大模型返回的 JSON 结果
- 支持单工具和多工具链式调用
- 将前一个工具的结果传递给下一个工具（如文档生成工具可以使用前一个工具的数据）

### 1.3 配置说明

在 `.env` 文件中配置：
- `LLM_API_KEY`: 大模型 API Key
- `LLM_BASE_URL`: API 基础 URL（可选，默认使用 DashScope）
- `LLM_MODEL`: 模型名称（如 `qwen-turbo`、`gpt-3.5-turbo`）

### 1.4 降级方案

当大模型 API 不可用时，系统自动降级到基于规则的意图识别：
- 通过关键词匹配识别用户意图
- 提取参数（如城市名称、查询关键词等）
- 返回工具调用指令

**优点：** 不依赖外部 API，系统仍可运行，响应速度快  
**缺点：** 无法处理复杂意图，不支持多工具链式调用

---

## 二、工具接入

### 2.1 功能概述

工具接入采用注册表模式，所有工具必须在 `app/tools/__init__.py` 中注册才能被调用。每个工具都支持真实 API 调用和 Mock 数据降级。

### 2.2 核心文件

#### `app/tools/__init__.py` - 工具注册表

**功能：** 注册所有可用工具，定义工具的基本信息（函数、描述、参数等）。

**当前已注册的工具：**
- `weather`: 天气查询工具
- `news`: 新闻检索工具
- `stock`: 股票数据查询工具
- `calculate`: 数值计算工具
- `document`: 文档生成工具

#### `app/core/scheduler.py` - 工具调度器

**功能：** 负责调用和管理工具，提供统一的工具调用接口。

**主要功能：**
- 异步调用指定工具
- 错误处理和取消操作支持
- 统一的返回格式

### 2.3 现有工具说明

#### 1. 天气工具 (`weather`)

**功能：** 查询指定城市的天气信息（支持7天预报）

**参数：** `location`（城市名称）、`days`（查询天数，默认7天）

**API 支持：** 心知天气（优先）→ 和风天气（降级）→ Mock 数据

#### 2. 新闻工具 (`news`)

**功能：** 根据关键词检索新闻

**参数：** `query`（搜索关键词）、`limit`（返回数量，默认10条）

**API 支持：** NewsAPI.org → Mock 数据

#### 3. 股票工具 (`stock`)

**功能：** 查询股票历史价格数据

**参数：** `symbol`（股票代码或名称）、`days`（查询天数，默认5天）

**API 支持：** Alpha Vantage → Mock 数据

#### 4. 计算工具 (`calculate`)

**功能：** 执行数学计算

**参数：** `expression`（计算表达式，如 "2+3"）

#### 5. 文档生成工具 (`document`)

**功能：** 生成报告、邮件、总结等文档

**参数：** `template`（模板类型：report/email/summary）、`content`（内容提示）、`data`（上下文数据，可选）

**特点：** 使用大模型生成文档内容，支持基于前一个工具的数据生成总结

### 2.4 工具实现规范

每个工具必须：
1. 返回统一的格式：`{"success": bool, "data": {...}, "error": str, "metadata": {...}}`
2. 支持参数校验
3. 优先使用真实 API，失败时降级到 Mock 数据
4. 在 `app/tools/__init__.py` 中注册

### 2.5 添加新工具

添加新工具需要：
1. 创建工具文件并实现工具函数
2. 在 `app/tools/__init__.py` 中注册
3. 在 `app/core/prompt.py` 中添加工具说明
4. 在 `app/core/agent.py` 中添加参数处理逻辑
5. 在 `app/api/routes.py` 中添加结果格式化逻辑

---

## 三、前后端连接

### 3.1 功能概述

前后端通过 RESTful API 进行通信，使用 FastAPI 框架提供后端服务。

**通信流程：**
1. 前端发送 HTTP POST 请求到 `/api/workflow/execute`
2. 后端调用 Agent 进行意图识别和工具调度
3. 后端执行工具，获取结果
4. 后端格式化结果，返回 JSON 响应
5. 前端接收响应，渲染结果

### 3.2 核心文件

#### `app/main.py` - FastAPI 应用入口

**功能：** 创建 FastAPI 应用，配置 CORS（跨域资源共享），注册路由。

#### `app/api/routes.py` - API 路由定义

**功能：** 定义 API 端点，处理请求和响应。

**主要端点：**
- `POST /api/workflow/execute`: 执行工作流，接收用户自然语言输入，返回执行结果
- `GET /api/tools/status`: 查询工具状态

### 3.3 API 接口规范

#### 请求格式

**端点：** `POST /api/workflow/execute`

**请求体：**
```json
{
    "userInput": "查北京天气",
    "conversationId": "optional_conversation_id"
}
```

#### 响应格式

**成功响应：**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "taskId": "1234567890",
        "status": "success",
        "steps": [...],      // 工作流步骤
        "logs": [...],       // 工具调用日志
        "result": {
            "summary": "...",      // 文本摘要
            "chartType": "line",   // 图表类型
            "chartData": [...],    // 图表数据
            "rawData": [...]       // 原始数据
        }
    }
}
```

#### 结果数据格式

**单工具结果：**
- `summary`: 文本摘要
- `chartType`: 图表类型（"line" | "bar" | "none"）
- `chartData`: 图表数据数组
- `rawData`: 原始数据数组

**多工具结果：**
- `summary`: 合并的文本摘要
- `chartType`: 第一个工具的图表类型
- `chartData`: 第一个工具的图表数据
- `rawData`: 数组，每个元素包含 `type`、`title`、`data`、`chartType`、`chartData`

### 3.4 数据流转

**单工具调用：** 用户输入 → 意图识别 → 工具执行 → 结果格式化 → 返回响应

**多工具链式调用：** 用户输入 → 识别多个工具 → 循环执行工具链 → 合并结果 → 返回响应

### 3.5 结果格式化

后端根据不同的工具类型，将工具返回的原始数据格式化为前端需要的格式：
- 天气工具：生成天气摘要，提取温度、湿度用于图表
- 新闻工具：生成新闻摘要，返回文章列表
- 股票工具：生成股票摘要，提取价格、成交量用于图表
- 多工具组合：合并多个工具的结果，每个工具的数据单独组织

---

## 总结

本后端系统采用模块化设计，主要特点：

1. **大模型接入层**：抽象设计，支持多种大模型服务，具备降级方案
2. **工具接入层**：注册表模式，易于扩展新工具
3. **前后端连接**：RESTful API，统一的数据格式，支持单工具和多工具链式调用

通过这三个层次的协作，实现了从用户自然语言输入到工具执行再到结果返回的完整流程。

